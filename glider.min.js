// glider - v0.0.0 - 1/29/2012
// 
// ; Licensed 
(function(a){function f(a,b,c){var d,g=Array.prototype.slice;c.length>0?e(b,function(){var b=c[0]();f(a,b,g.call(c,1))}):e.chain(b,a)}var b=a.document,c=a.XMLHttpRequest,d=a.setTimeout,e=a.when,$=a.$,g=Object.create({init:function(){return this.objects={},this.promises={},this.loadedAs={},this.paths={script:"src/",data:"data/"},this},set:function(a,b){this.objects[a]=b},get:function(a){return this.objects[a]},type:function(a){return typeof a=="string"?this.loadedAs[a]:a.type},fixPath:function(a,b){return this.paths[a]+b},guessType:function(a){return/\.(png|jpg|jpeg$)/i.test(a)?"image":/\.txt$/i.test(a)?"text":/\.json$/i.test(a)?"json":"data"},chain:function(a,b){var c=e.defer();return f(c,a,Array.prototype.slice.call(arguments,1)),c},script:function(c){var f,g;if(this.promises[c])return this.promises[c];if(!this.objects[c]){f=$('script[src="'+this.fixPath("script",c)+'"]')[0];if(f)return g=e.defer(),g.resolve(),this.objects[c]=f,this.promises[c]=g.promise,this.promises[c]}return f=a.document.createElement("script"),g=e.defer(),this.objects[c]=f,this.promises[c]=g.promise,f.onload=function(){d(function(){f.promise?f.promise.then(g.resolve.bind(g,f)):g.resolve(f)},0)},f.src=this.fixPath("script",c),b.head.appendChild(f),g.promise},module:function(a,b,c){this.objects[a]||(this.objects[a]=$('script[src="'+this.fixPath("script",a)+'"]')[0]),b?(this.objects[a].promise=b,b.then(c)):c()},text:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="text",this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.responseText,d.resolve(b.responseText)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.send(),d.promise},data:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="data",this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.response,d.resolve(b.response)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.responseType="arraybuffer",b.send(),d.promise},json:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="json",this.promises[a]=d.promise,b.onload=function(){try{this.objects[a]=JSON.parse(b.responseText)}catch(c){console.error("failed to parse "+a),console.error(c.toString())}d.resolve(b.responseText)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.send(),d.promise},image:function(a){if(this.promises[a])return this.promises[a];var b=new Image,c=e.defer();return this.loadedAs[a]="image",this.promises[a]=c.promise,b.onload=function(){this.objects[a]=b,c.resolve(b)}.bind(this),b.onerror=function(){c.reject()},b.src=this.fixPath("data",a),c.promise},load:function(a){return typeof a=="string"?this[this.guessType(a)](a):this[a.type](a.path)},"package":function(a){function h(a){if(!a)return;var d;c+=a.length;for(d=0;d<a.length;d++)g.load(a[d]).then(function(a){console.log(a,g.type(a)),g.type(a)=="json"&&h(g.get(a).files),c--,c==0&&b.resolve()}.bind(this,a[d]))}if(this.promises[a])return this.promises[a];var b=e.defer(),c=0,d=/^{/,f;return typeof a=="object"?(h(a.files),c==0&&b.resolve()):d.test(a.trim())?(f=JSON.parse(a),h(f.files),c==0&&b.resolve()):g.json(a).then(function(){h(g.get(a).files),c==0&&b.resolve()}),this.promises[a]=b.promise,b.promise},definition:function(a){function b(a,c){return c.file&&b(a,g.get(c.file)),jQuery.extend(!0,a,c)}return b({},a)}}).init();a.load=g})(this),function(a,b){function g(a,c){var d=b.get(c);d.promise?d.promise.then(a.resolve.bind(a,d)):a.resolve(d)}var c=a.setTimeout,d=a.when,e=["engine/init.js","engine/math.js","engine/base.js","engine/object.js","engine/paper_graphics.js","engine/physics.js","game/common.js","game/bullet.js","game/enemy.js","game/level.js","game/ship.js","game/main.js"],f;e.forEach(function(a){var e=d.defer();b.set(a,{}),b.promises[a]=e,c(g.bind(null,e,a),0)})}(this,this.load),function(a){var b=a.when,c=a.aqua={};c.type=function(a,b,c,d){c=c||{},d=d||{};var e={},f;e.prototype=Object.create(a.prototype||{},c);for(f in b)e.prototype[f]=b[f];e.prototype.init||(e.prototype.init=function(){});for(f in d)e[f]=d[f];return e.create||(e.create=function(){var a=Object.create(e.prototype);return a.init.apply(a,arguments),a}),e},c.type.Base=c.type({},{}),c.extend=function(a,b){for(var c in b)a[c]=b[c];return a},c.requestAnimFrame=function(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b,c){a.setTimeout(b,1e3/60)}}(),c.PriorityItem=c.type(c.type.Base,{init:function(a,b,c,d,e){this.callback=a,this.priority=b||0,this.before=c||!1,this.once=d||!1,this.rate=e||1/60,this.sinceLast=0},call:function(){this.callback.apply(null,arguments)}}),c.PriorityList=c.type(c.type.Base,{init:function(){this.items=[]},add:function(a){var b=0,c=!1;for(;b<this.items.length;b++)if(a.before&&this.items[b].priority>=a.priority||!a.before&&this.items[b].priority>a.priority){this.items.splice(b,0,a),c=!0;break}c||this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);return b!=-1&&this.items.splice(b,1),this},callAll:function(){var a=this.items,b=0,c;for(;b<a.length;b++)c=a[b],c.call.apply(c,arguments),c.once&&(a.splice(b,1),b--)}}),c.Emitter=c.type(c.type.Base,{on:function(a,b){this._events||(this._events={}),this._events[a]||(this._events[a]=[]),this._events[a].indexOf(b)==-1&&this._events[a].push(b)},off:function(a,b){var c=-1;this._events||(this._events={}),this._events[a]&&(c=this._events[a].indexOf(b))&&this._events[a].splice(c,1)},call:function(a){this._events||(this._events={});if(this._events[a]){var b=[],c,d=this._events[a];for(c=1;c<arguments.length;c++)b.push(arguments[c]);for(c=0;c<d.length;c++)d[c].apply(this,b)}}}),c.query=function(a,b){var c=location.search.substring(1).split("&"),d,e;for(d=0;d<c.length;d++){e=c[d].split("=");if(e[0]==a)return unescape(e[1])}return b},c.superCall=function(a,b){var c=arguments.slice(2);return Object.getPrototypeOf(Object.getPrototypeOf(a))[b].apply(a,c)}}(this),function(a){Math.mag=function(a,b){return Math.sqrt(a*a+b*b)},Math.lerp=function(a,b,c){return(b-a)*c+a},Math.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)}}(this),function(a,b){var c=b.type(b.type.Base,{init:function(){this.objects=[],this.tasks=b.PriorityList.create(),this.task(this.call.bind(this,"update")),this.task(this.call.bind(this,"lateUpdate"),c.Priorities.LATE_UPDATE)},add:function(a){a.game=this,this.objects.push(a),a.ongameadd&&a.ongameadd(this),a.call("ongameadd",a,this)},destroy:function(a){this.task(function(){var b=this.objects.indexOf(a);b!=-1&&(a.ongamedestroy&&a.ongamedestroy(this),a.call("on","gamedestroy",a,this),a.call("ongamedestroy",a,this),a.game=null,this.objects.splice(b,1))}.bind(this),c.Priorities.GARBAGE,!1,!0)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.objects,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e.call.apply(e,arguments)},task:function(a,c,d,e){var f=b.PriorityItem.create.apply(b.PriorityItem,arguments);return this.tasks.add(f),f},step:function(){this.tasks.callAll(this)},main:function(){},pause:function(){},resume:function(){}},{},{Priorities:{UPDATE:0,LATE_UPDATE:5,RENDER:10,GARBAGE:20}}),d=b.type(b.type.Base,{init:function(){this.components=[]},add:function(a){return a.gameObject=this,this.components.push(a),a.onadd(this),this.game&&a.ongameadd(this,this.game),a},get:function(a){var b=this.components,c=b.length,d=a.prototype,e,f;for(f=0;f<c;f++){e=b[f];if(d.isPrototypeOf(e))return e}return null},destroy:function(a){function b(){var b=this.components.indexOf(a);b!=-1&&(a.ondestroy(this),this.game&&(a.ongamedestroy(this,this.game),a.on("gamedestroy",this,this.game)),a.gameObject=null,this.components.splice(b,1))}this.game?this.game.task(b.bind(this),c.Priorities.GARBAGE,!1,!0):b.call(this)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.components,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e[a]&&e[a].apply(e,b)}}),e=b.type(b.Emitter,{onadd:function(a){},ongameadd:function(a,b){},ondestroy:function(a){},ongamedestroy:function(a,b){}});b.Game=c,b.GameObject=d,b.Component=e}(this,this.aqua),function(a,b){b.module("engine/paper_graphics.js",null,function(){var a=aqua.type(aqua.type.Base,{init:function(){this.rasters={},this.animations={},this.symbols={}},hasRaster:function(a){return!!this.rasters[a]},loadRaster:function(a){return this.rasters[a]||(this.rasters[a]=new paper.Raster(b.get(a)),this.rasters[a].remove(),this.symbols[a]=new paper.Symbol(this.rasters[a])),this.rasters[a]},saveRaster:function(a,b){return this.rasters[a]=b,b},loadSymbol:function(a){return this.rasters[a]||(this.rasters[a]=new paper.Raster(b.get(a)),this.rasters[a].remove(),this.symbols[a]=new paper.Symbol(this.rasters[a])),this.symbols[a]},loadAnimation:function(a){return this.animations[a]||(this.animations[a]=c.create(a)),this.animations[a]}}),c=aqua.type(aqua.type.Base,{init:function(a){this.framesets={},this.rasters=[],this.symbols=[],this.names=[],this.def=b.definition(a)},get:function(a,b){}}),d=aqua.type(aqua.Component,{init:function(){this.position=[],this.angle=0}}),e=aqua.type(aqua.Component,{init:function(a,b){this.path=a,this.transformClass=b||d},ongameadd:function(a,b){this.game=b,this.transform=a.get(this.transformClass),this.raster||(this.raster=new paper.PlacedSymbol(b.graphics.loadSymbol(this.path)))},ongamedestroy:function(){this.raster.remove(),delete this.raster},lateUpdate:function(){this.raster.position.x=this.transform.position[0],this.raster.position.y=this.transform.position[1],this.transform.angle!=this.angle&&(this.raster.rotate(this.angle-this.transform.angle),this.transform.angle=this.angle)}}),f=aqua.type(e,{});aqua.Graphics=a,aqua.Transform=d,aqua.RasterRenderer=e})}(this,this.load),function(a,b){var c=a.ArrayBuffer,d=a.Float32Array,e=a.Uint8Array,f=a.when,g=a.aqua,h=a.vec3;b.module("engine/physics.js",f.all([b.script("engine/object.js"),b.script("engine/paper_graphics.js"),b.script("engine/math.js")]),function(){function f(a,b,c){return b+c*a.cellsWide}var a=2,b=1,c=0,d=g.type(g.Emitter,{init:function(a,b,e){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.apply(this),this.position=a.slice(),this.lastPosition=a.slice(),this.oldPosition=a.slice(),this.velocity=[0,0,0],this.acceleration=[0,0,0],this.angle=0,this.maxVelocity=5,this.temporaryPosition=a.slice(),this.radius=b,this.mass=e*b*b,this.mask=d.Masks.LIQUID,this.collisionMask=d.Masks.ALL,this.friction=c},integrate:function(c){this.isStatic||(h.set(this.position,this.temporaryPosition),h.add(h.subtract(h.scale(this.position,a,this.position),h.scale(this.lastPosition,b,this.lastPosition),this.position),h.scale(this.acceleration,c*c,this.acceleration),this.position),h.set(this.temporaryPosition,this.lastPosition)),this.x=this.position[0],this.y=this.position[1],this.lx=this.lastPosition[0],this.ly=this.lastPosition[1],this.velocity[0]=this.position[0]-this.lastPosition[0],this.velocity[1]=this.position[1]-this.lastPosition[1],h.dot(this.velocity,this.velocity)>this.maxVelocity*this.maxVelocity&&(this.velocity=h.scale(h.normalize(this.velocity),this.maxVelocity),this.x=this.lastPosition[0]+this.velocity[0],this.y=this.lastPosition[1]+this.velocity[1],this.position[0]=this.x,this.position[1]=this.y),this.angle=Math.PI/2-Math.atan(this.velocity[1]/this.velocity[0]),this.velocity[0]<0&&(this.angle=Math.PI+this.angle);for(var d=0;d<3;d++)this.acceleration[d]=0},test:function(a,b){if(this.isStatic&&a.isStatic)return!1;var c=this.x,d=this.y,e=this.radius,f=a.x,g=a.y,h=a.radius,i=b,j;j=Math.pow(c-f,2)+Math.pow(d-g,2);if(j<Math.pow(e+h,2)){i.ingression=j=Math.mag(c-f,d-g),i.weight=e+h,i.distance=i.ingression-i.weight;var k=c-f,l=d-g,m=j,n=(m-e)/m,o=h/m;return i.px=f+Math.lerp(0,k,n),i.py=g+Math.lerp(0,l,n),i.qx=f+Math.lerp(0,k,o),i.qy=g+Math.lerp(0,l,o),!0}return!1},solve:function(a,b){var c=this,d=a,e=b,f=(e.qx-e.px)*.5,g=(e.qy-e.py)*.5,h=c.mass,i=d.mass,j=h+i,k=i/j,l=h/j,m=c.lx-c.x,n=c.ly-c.y,o=Math.mag(m,n),p=d.lx-d.x,q=d.ly-d.y,r=Math.mag(p,q),s=Math.abs(e.distance)*(o+r>50?.1:c.friction*d.friction);o!=0&&(m=m/o*(o-s),n=n/o*(o-s)),r!=0&&(p=p/r*(r-s),q=q/r*(r-s)),c.isStatic?(k=0,l=1):d.isStatic&&(k=1,l=0);var t=!0;c.isTrigger&&(c.call("collision",d,e),t=!1),d.isTrigger&&(d.call("collision",c,e),t=!1),t&&(c.lastPosition[0]=c.lx=c.position[0]+m,c.lastPosition[1]=c.ly=c.position[1]+n,c.position[0]+=f*k,c.x=c.position[0],c.position[1]+=g*k,c.y=c.position[1],d.lastPosition[0]=d.lx=d.position[0]+p,d.lastPosition[1]=d.ly=d.position[1]+q,d.position[0]-=f*l,d.x=d.position[0],d.position[1]-=g*l,d.y=d.position[1])}},{isStatic:{get:function(){return!!(this.mask&d.Masks.STATIC)},set:function(a){a?this.mask|=d.Masks.STATIC:this.mask=(this.mask|d.Masks.STATIC)^d.Masks.STATIC}},isTrigger:{get:function(){return!!(this.mask&d.Masks.TRIGGER)},set:function(a){a?this.mask|=d.Masks.TRIGGER:this.mask=(this.mask|d.Masks.TRIGGER)^d.Masks.TRIGGER}}},{Masks:{LIQUID:1,SOLID:2,GAS:4,STATIC:8,TRIGGER:16,ALL:-1}}),e=g.type(g.type.Base,{init:function(a,b,c,d){this.top=a,this.right=b,this.bottom=c,this.left=d,this.width=b-d,this.height=a-c},contains:function(a){return a[0]<this.right&&a[0]>this.left&&a[1]<this.top&&a[1]>this.bottom},copy:function(){return e.create(this.top,this.right,this.bottom,this.left)},translate:function(a,b){this.top+=b,this.bottom+=b,this.left+=a,this.right+=a}}),i=g.type(g.type.Base,{init:function(a,b){this.hash={},this.arrayHash=[],this.box=a,this.newBox=b.copy(),this.lastBox=b.copy(),this.cellsWide=Math.ceil(b.width/a.width),this.cellsTall=Math.ceil(b.height/a.height);for(var c=0;c<this.cellsWide;c++)for(var d=0;d<this.cellsTall;d++)this.arrayHash[f(this,c,d)]=[]},each:function(a){var b;for(b=0;b<this.arrayHash.length;b++)this.arrayHash[b]&&a(this.arrayHash[b],Math.floor(b/this.cellsWide),b%this.cellsWide)},cell:function(a,b){return this.arrayHash[f(this,Math.floor((a-this.lastBox.left)/this.box.width),Math.floor((b-this.lastBox.bottom)/this.box.height))]},add:function(a){var b=a.x,c=a.y,d=a.radius,e=this.box.width,g=this.box.height,h=this.cellsWide,i=this.cellsTall,j=this.newBox,k=Math.floor((b+d-j.left)/e+1),l=Math.floor((c+d-j.bottom)/g+1),m,n;for(m=Math.floor((b-d-j.left)/e);m>=0&&m<h&&m<k;m++)for(n=Math.floor((c-d-j.bottom)/g);n>=0&&n<i&&n<l;n++){var o=f(this,m,n),p=this.arrayHash[o];p.push(a)}a.oldX=a.x,a.oldY=a.y},remove:function(a){var b=a.oldX,c=a.oldY,d=a.radius,e=this.box.width,g=this.box.height,h=this.cellsWide,i=this.cellsTall,j=this.lastBox,k=Math.floor((b+d-j.left)/e+1),l=Math.floor((c+d-j.bottom)/g+1),m,n;for(m=Math.floor((b-d-j.left)/e);m>=0&&m<h&&m<k;m++)for(n=Math.floor((c-d-j.bottom)/g);n>=0&&n<i&&n<l;n++){var o=f(this,m,n),p=this.arrayHash[o],q=p.indexOf(a);p[q]=p[p.length-1],p.pop()}},update:function(a){this.remove(a),this.add(a)}},{},{}),j=g.type(g.GameObject,{init:function(a){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this),this.particles=[],this.collision={},this.box=a,this.gravity=[0,0,0],this.fixedDelta=.05,this.timeToPlay=0,a=a.copy(),a.left-=50,a.right+=50,a.top+=50,a.bottom-=50,this.hash=i.create(e.create(50,50,0,0),a)},ongameadd:function(a){this.task=a.task(this.update.bind(this),g.Game.Priorities.LATE_UPDATE)},ongamedestroy:function(a){a.tasks.remove(this.task)},addParticle:function(a){this.particles.push(a),this.hash.add(a),a.index=this.particles.length-1},removeParticle:function(a){this.game.task(function(){var b=this.particles.indexOf(a);b!=-1&&(this.particles[b]=this.particles[this.particles.length-1],this.particles[b].index=b,this.particles.pop(),this.hash.remove(a))}.bind(this),g.Game.Priorities.GARBAGE,!1,!0)},update:function(){var a=this.fixedDelta;this.game.timing.fixedDelta=a,this.timeToPlay+=this.game.timing.delta,this.timeToPlay>.05&&(this.timeToPlay-=.05,this.game.call("fixedUpdate",this),this.step(a))},step:function(a){var b=this.particles,c=this.collision,d=this.box,e=b.length,f,g,i,j;c.test=0,c.collided=0;for(f=0;f<e;f++)i=b[f],h.add(i.acceleration,this.gravity,i.acceleration),i.integrate(a);var k=0,l=[],m=this.hash;this.hash.each(function(a){k=a.length,l.splice(0,l.length);for(f=0;f<k;f++){i=a[f];for(g=f+1;g<k;g++)j=a[g],i.test(j,c)&&(i.solve(j,c),l.indexOf(i)==-1&&l.push(i),l.indexOf(j)==-1&&l.push(j))}for(f=0;f<l.length;f++)m.update(l[f])}),this.hash.newBox=this.box.copy();for(f=0;f<e;f++){i=b[f];if(i.position[0]<d.left){var n=i.position[0]-i.lastPosition[0];i.position[0]=d.right,i.lastPosition[0]=i.position[0]-n}if(i.position[0]>d.right){var n=i.position[0]-i.lastPosition[0];i.position[0]=d.left,i.lastPosition[0]=i.position[0]-n}if(i.position[1]>d.top){var o=i.position[1]-i.lastPosition[1];i.position[1]=d.bottom,i.lastPosition[1]=i.position[1]-o}if(i.position[1]<d.bottom){var o=i.position[1]-i.lastPosition[1];i.position[1]=d.top,i.lastPosition[1]=i.position[1]-o}this.hash.update(i)}this.hash.lastBox=this.box.copy()}}),k=g.type(g.Component,{onadd:function(a){this.world=a,this.paths||(this.paths=[])},lateUpdate:function(){var a,b,c;for(a=this.paths.length;a<this.world.particles.length;a++)b=new paper.Path.Circle(new paper.Point(0,0),1),b.fillColor="red",b.currentSize=1,this.paths.push(b);for(a=this.paths.length;a>this.world.particles.length;a--)this.paths.pop().remove();for(a=0;a<this.world.particles.length;a++)b=this.paths[a],c=this.world.particles[a],b.scale(c.radius/b.currentSize),b.currentSize=c.radius,b.translate(new paper.Point(c.position[0]-b.position.x,c.position[1]-b.position.y))}});g.Particle=d,g.World=j,g.World.PaperRenderer=k,g.Box=e})}(this,this.load),function(a,b){var c=a.when;b.module("engine/init.js",b.chain(b.script("engine/base.js"),function(){return c.all([b.script("engine/object.js"),b.script("engine/paper_graphics.js"),b.script("engine/physics.js")])}),function(){})}(this,this.load),function(a,b){a.glider={},a.btb={};var c=a.when;b.module("game/main.js",b.chain(b.script("engine/init.js"),function(){return c.all([b.script("game/ship.js"),b.script("game/enemy.js"),b.script("game/level.js"),b.script("game/common.js")])}),function(){setTimeout(function(){function f(){d.requestAnimFrame.call(null,f),d.game.step()}var $=a.$,b=a.when,c=a.mat4,d=a.aqua,e=a.glider;d.game=d.Game.create(),d.game.tallyStuff={},paper.setup($("canvas")[0]),paper.view.viewSize.width=800,paper.view.viewSize.height=600,d.game.task(paper.view.draw.bind(paper.view),d.Game.Priorities.RENDER),d.game.graphics=d.Graphics.create(),d.game.timing={delta:0,last:Date.now()},d.game.task(function(){var a=Date.now();d.game.timing.delta=Math.clamp((a-d.game.timing.last)/1e3,0,.3),d.game.timing.last=a},-10),d.game.world=d.World.create(d.Box.create(600,800,0,0)),d.game.add(d.game.world),d.game.player=btb.makeShip(),d.game.add(d.game.player),d.game.levelManager=btb.LevelManager.makeLevelManager(),d.game.add(d.game.levelManager),f()},0)})}(this,this.load),function(a,b){b.module("game/bullet.js",null,function(){var a=aqua.type(aqua.Component,{init:function(a){this.def=a,this.kind="untracked",a.kind&&(this.kind=a.kind)},ongameadd:function(a,b){aqua.game.tallyStuff[this.kind]?aqua.game.tallyStuff[this.kind]+=1:aqua.game.tallyStuff[this.kind]=1,console.log(this.kind+" :"+aqua.game.tallyStuff[this.kind])},ongamedestroy:function(a,b){aqua.game.tallyStuff[this.kind]-=1,console.log(this.kind+" :"+aqua.game.tallyStuff[this.kind]),aqua.game.tallyStuff["enemy"]==0&&aqua.game.tallyStuff["bullet"]==0&&setTimeout("aqua.game.levelManager.transition()",3e3)}});btb.TallyType=a})}(this,this.load),function(a,b){b.module("game/bullet.js",null,function(){var a=aqua.type(aqua.Component,{radius:5,startTime:.5,init:function(a){this.def=a,this.angle=0,this.particle=aqua.Particle.create([0,0],this.radius,1),a.position&&this.setPosition(a.position),a.velocity&&this.setVelocity(a.velocity),a.startTime&&(this.startTime=a.startTime),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.particle.bullet=this,this.particle.source=a.source||null,this.particle.maxVelocity=200,this.startTimer=this.startTime,this.energyHarvested=!1},onadd:function(a){a.bullet=this,this.soundModel=a.get(d)},ongameadd:function(a,b){this.game=b,b.world.addParticle(this.particle),this.world=b.world},ongamedestroy:function(a,b){this.game=null,b.world.removeParticle(this.particle)},oncollision:function(a,b){if(this.game&&(a!=this.particle.source||this.startTimer<0)){a.bullet&&(a.source!=this.particle.source||this.startTimer<0)&&(this.game.destroy(this.gameObject),this.soundModel.play("bcollide"));if(a.ship){var c=Math.PI+a.ship.angle%(Math.PI*2),d=a.ship.particle.position[0]-this.particle.position[0],e=a.ship.particle.position[1]-this.particle.position[1],f=vec3.normalize([d,e,0]),g=vec3.normalize([Math.cos(c),Math.sin(c),0]),h=vec3.length(vec3.subtract(g,f));h<.9?(this.game.destroy(this.gameObject),this.soundModel.play("pickup")):this.game.destroy(a.ship.gameObject)}}},update:function(){this.startTimer-=aqua.game.timing.delta},setPosition:function(a){this.particle.position[0]=a[0],this.particle.position[1]=a[1];var b=this.particle.position[0]-this.particle.lastPosition[0],c=this.particle.position[1]-this.particle.lastPosition[1];this.particle.lastPosition[0]=a[0]-b,this.particle.lastPosition[1]=a[1]-c},setVelocity:function(a){this.particle.lastPosition[0]=this.particle.position[0]-a[0]*.05,this.particle.lastPosition[1]=this.particle.position[1]-a[1]*.05,this.angle=Math.atan2(this.particle.position[1]-this.particle.lastPosition[1],this.particle.position[0]-this.particle.lastPosition[0])}},{isLive:{get:function(){return this.startTimer<=0}}}),b=aqua.type(aqua.Component,{ongameadd:function(b,c){this.model=b.get(a);if(!this.path){var d=this.model.radius;d=Math.sqrt(d*d+d*d),this.path=new paper.Path.Rectangle(new paper.Rectangle(-d/2,-d/2,d,d)),this.path.fillColor="grey"}},ongamedestroy:function(){this.path.remove(),delete this.path},lateUpdate:function(){this.model.startTimer<0&&(this.path.fillColor="black"),this.path.position.x=this.model.particle.position[0],this.path.position.y=this.model.particle.position[1]}}),c=aqua.type(aqua.RasterRenderer,{init:function(b){this.angle=0,Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this,b.image,a)},lateUpdate:function(){this.raster.position.x=this.transform.particle.position[0],this.raster.position.y=this.transform.particle.position[1],this.transform.angle!=this.angle&&(this.raster.rotate((this.transform.angle-this.angle)/2/Math.PI*360),this.angle=this.transform.angle)}}),d=aqua.type(aqua.Component,{init:function(a){this.def=a,this.sounds={pickup:soundManager.createSound({id:"dSound",url:"data/ship/sfx/pickup-energy.wav"}),bcollide:soundManager.createSound({id:"dSound",url:"data/weapons/sfx/shoot-mine.wav"})}},play:function(a){if(!this.sounds[a])return!1;this.sounds[a].play()}});btb.Bullet=a,btb.BulletRender=b,btb.BulletRasterRender=c,btb.BulletSound=d})}(this,this.load),function(a,b){b.module("game/enemy.js",b.script("game/bullet.js"),function(){var a=aqua.type(aqua.Component,{init:function(a){this.def=a,this.sounds={explode:soundManager.createSound({id:"aSound",url:"data/enemy/sfx/explode-enemy1.wav"}),bullet:soundManager.createSound({id:"bSound",url:"data/weapons/sfx/shoot-bullet.wav"}),shipexplode:soundManager.createSound({id:"cSound",url:"data/ship/sfx/explode-ship1.wav"})}},play:function(a){if(!this.sounds[a])return!1;this.sounds[a].play()}}),c=aqua.type(aqua.Component,{init:function(a){this.def=a,this.particle=aqua.Particle.create(a.position||[100,100],a.radius||10,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.particle.enemy=this},ongameadd:function(b,c){this.gameObject=b,this.soundModel=b.get(a),this.game=c,c.world.addParticle(this.particle),this.particle.lastPosition[0]-=(this.def.velocity?this.def.velocity[0]:10)*.05,this.particle.lastPosition[1]-=(this.def.velocity?this.def.velocity[1]:10)*.05,this.angle=Math.atan2(this.particle.position[1]-this.particle.lastPosition[1],this.particle.position[0]-this.particle.lastPosition[0])},ongamedestroy:function(a,b){delete this.gameObject,delete this.game,b.world.removeParticle(this.particle),this.soundModel.play("explode")},oncollision:function(a,b){if(a.enemy)return;if(a.bullet&&!a.bullet.isLive&&a.source==this.particle)return;if(a.ship)return;this.gameObject.destroy(this),a.bullet&&this.game.destroy(a.bullet.gameObject),this.call("hit");var c=this.game,d=this.gameObject;setTimeout(function(){c.destroy(d)}.bind(this),250)}}),d=aqua.type(c,{init:function(a){this.def=a,this.particle=aqua.Particle.create(a.position||[100,100],a.radius||10,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.particle.enemy=this},update:function(){playerPos=aqua.game.player.components[0].gameObject.components[1].particle.position,this.angle=Math.atan2(this.particle.position[1]-playerPos[1],this.particle.position[0]-playerPos[0])+Math.PI},ongameadd:function(b,c){this.gameObject=b,this.soundModel=b.get(a),this.game=c,c.world.addParticle(this.particle),this.particle.lastPosition[0]-=(this.def.velocity?this.def.velocity[0]:10)*.05,this.particle.lastPosition[1]-=(this.def.velocity?this.def.velocity[1]:10)*.05,this.angle=Math.atan2(this.particle.position[1]-this.particle.lastPosition[1],this.particle.position[0]-this.particle.lastPosition[0])},ongamedestroy:function(a,b){delete this.gameObject,delete this.game,b.world.removeParticle(this.particle),this.soundModel.play("explode")},oncollision:function(a,b){if(a.enemy)return;if(a.bullet&&!a.bullet.isLive&&a.source==this.particle)return;if(a.ship)return;this.gameObject.destroy(this),a.bullet&&this.game.destroy(a.bullet.gameObject),this.call("hit");var c=this.game,d=this.gameObject;setTimeout(function(){c.destroy(d)}.bind(this),250)}}),e=aqua.type(aqua.Component,{defaults:{fireDelay:2},init:function(a){this.def=a,this.fireTimer=this.def.fireDelay||this.defaults.fireDelay},onadd:function(b){this.moveModel=b.get(c),this.soundModel=b.get(a)},update:function(){this.fireTimer-=aqua.game.timing.delta,this.fireTimer<=0&&(this.fire(),this.fireTimer=this.def.fireDelay||this.defaults.fireDelay)},fire:function(){var a=this.def.bulletSpeed||30,b=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0],this.moveModel.particle.position[1]],velocity:[Math.cos(this.moveModel.angle)*a,Math.sin(this.moveModel.angle)*a],source:this.moveModel.particle}}));aqua.game.add(b),this.soundModel.play("bullet")}}),f=aqua.type(e,{defaults:{fireDelay:3},init:function(a){this.def=a,this.fireTimer=this.def.fireDelay||this.defaults.fireDelay},onadd:function(b){this.moveModel=b.get(c),this.soundModel=b.get(a)},update:function(){this.fireTimer-=aqua.game.timing.delta,this.fireTimer<=0&&(this.fire(),this.fireTimer=this.def.fireDelay||this.defaults.fireDelay)},fire:function(){var a=this.def.bulletSpeed||30,b=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0],this.moveModel.particle.position[1]],velocity:[Math.cos(this.moveModel.angle)*a,Math.sin(this.moveModel.angle)*a],source:this.moveModel.particle}})),c=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0],this.moveModel.particle.position[1]],velocity:[Math.cos(this.moveModel.angle+Math.PI/8)*a,Math.sin(this.moveModel.angle+Math.PI/8)*a],source:this.moveModel.particle}})),d=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0],this.moveModel.particle.position[1]],velocity:[Math.cos(this.moveModel.angle-Math.PI/8)*a,Math.sin(this.moveModel.angle-Math.PI/8)*a],source:this.moveModel.particle}}));aqua.game.add(b),aqua.game.add(c),aqua.game.add(d),this.soundModel.play("bullet")}}),g=aqua.type(aqua.Component,{init:function(a){this.def=a},onadd:function(a){this.moveModel=a.get(c)},ongameadd:function(a,b){this.pathAngle=0;var c=this.moveModel.particle.radius;c=Math.sqrt(c*c+c*c),this.path=new paper.Path.Rectangle(new paper.Rectangle(-c/2,-c/2,c,c)),this.path.fillColor=this.def.color||"orange",this.moveModel.on("hit",this.onhit.bind(this))},ongamedestroy:function(a,b){this.path.remove(),delete this.path},lateUpdate:function(){this.path.position.x=this.moveModel.particle.position[0],this.path.position.y=this.moveModel.particle.position[1],this.moveModel.angle!=this.pathAngle&&(this.path.rotate((this.moveModel.angle-this.pathAngle)/2/Math.PI*360),this.pathAngle=this.moveModel.angle)},onhit:function(){this.path.fillColor=this.def.hitColor||"red"}}),h=aqua.type(aqua.RasterRenderer,{init:function(a){this.angle=0,Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this,a.image,c)},lateUpdate:function(){this.raster.position.x=this.transform.particle.position[0],this.raster.position.y=this.transform.particle.position[1],this.transform.angle!=this.angle&&(this.raster.rotate((this.transform.angle-this.angle)/2/Math.PI*360),this.angle=this.transform.angle)}}),i=aqua.type(aqua.Component,{init:function(a){this.def=a,this.timer=a.spawnDelay||1},ongameadd:function(a,b){this.gameObject=a,this.game=b},update:function(){this.timer<0&&(this.game.add(btb.make(this.def)),this.game.destroy(this.gameObject)),this.timer-=this.game.timing.delta}});btb.Enemy=aqua.type(aqua.Component,{}),btb.Enemy.Move=c,btb.Enemy.MoveSpread=d,btb.Enemy.Attack=e,btb.Enemy.AttackSpread=f,btb.Enemy.Render=g,btb.Enemy.RasterRender=h,btb.Enemy.Spawner=i,btb.Enemy.Sound=a,btb.EnemyMove=c,btb.EnemyMoveSpread=d,btb.EnemyAttack=e,btb.EnemyAttackSpread=f,btb.EnemyRender=g,btb.EnemyRasterRender=h,btb.EnemySpawner=i,btb.EnemySound=a,btb.makeEnemy=function(a){var b=aqua.GameObject.create();return b.add(btb.Enemy[a.sound.type||"Sound"].create(a.sound)),b.add(btb.Enemy[a.move.type||"Move"].create(a.move)),b.add(btb.Enemy[a.attack.type||"Attack"].create(a.attack)),b.add(btb.Enemy[a.render.type||"Render"].create(a.render)),b},btb.make=function(a){var c=aqua.GameObject.create(),d,e,f,g,h;a=b.definition(a),f=Object.keys(a),a.components?f=a.components:(a.order&&(a.order.forEach(function(a){var b=f.indexOf(a);b!=-1&&f.splice(b,1)}),g=a.order.slice(),g.splice(0,0,0,0),f.splice.apply(f,g)),["files","file","order"].forEach(function(a){var b=f.indexOf(a);b!=-1&&f.splice(b,1)}));for(h=0;h<f.length;h++)e=null,d=f[h],a[d].type&&(e=btb[a[d].type],e||(e=btb["Enemy"+a[d].type])),e||(e=btb[d],e||(e=btb[d.charAt(0).toUpperCase()+d.substring(1)],e||(e=btb["Enemy"+d.charAt(0).toUpperCase()+d.substring(1)]))),e?c.add(e.create(a[d])):console.error('no such component type "'+d+'" or "'+a[d].type+'".');return c}})}(this,this.load),function(a,b){b.module("game/ship.js",b.script("game/bullet.js"),function(){var c=a.when,d=aqua.type(aqua.Component,{jsonRE:/^{/,init:function(a){this.ready=c.defer(),this.waiting=0;var d;typeof a=="object"?(this.def=a,d=b.package(a)):this.jsonRE.test(a.trim())?(d=b.package(a),this.def=JSON.parse(a)):(d=b.package(a),d.then(function(){this.def=b.get(a)}.bind(this))),c.chain(d,this.ready)},loadEnemy:function(a,c){return c.file&&this.loadEnemy(a,b.get(c.file)),jQuery.extend(!0,a,c)},start:function(){this.ready.then(function(){$("#title").text(this.def.title);var a,b,c,d,e;for(a=0;a<this.def.enemies.length;a++)c=this.def.enemies[a],e=aqua.GameObject.create(),e.add(btb.Enemy.Spawner.create(c)),aqua.game.add(e)}.bind(this))}}),e=aqua.type(aqua.GameObject,{init:function(){console.log("huh?"),Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this),this.level=null,this.levelIndex=parseInt(aqua.query("level",1))-1,this.gameObject=this,this.next()},next:function(){aqua.game.tallyStuff.enemy-=1,$("#levelcomplete").hide(),this.level=d.create("levels/level"+ ++this.levelIndex+".json"),this.gameObject.add(this.level),this.level.start(),aqua.game.player.components[0].gameObject.components[1].particle.position[0]=400,aqua.game.player.components[0].gameObject.components[1].particle.lastPosition[0]=400,aqua.game.player.components[0].gameObject.components[1].particle.position[1]=300,aqua.game.player.components[0].gameObject.components[1].particle.lastPosition[1]=300},repeat:function(){aqua.game.tallyStuff.enemy-=1,$("#levelcomplete").hide(),$("#leveldied").hide(),this.level=d.create("levels/level"+this.levelIndex+".json"),this.gameObject.add(this.level),this.level.start(),aqua.game.player.components[0].gameObject.components[1].particle.position[0]=400,aqua.game.player.components[0].gameObject.components[1].particle.lastPosition[0]=400,aqua.game.player.components[0].gameObject.components[1].particle.position[1]=300,aqua.game.player.components[0].gameObject.components[1].particle.lastPosition[1]=300},transition:function(){$("#levelcomplete").show(),aqua.game.tallyStuff.enemy+=1},playerdied:function(){$("#leveldied").show(),aqua.game.tallyStuff.enemy+=1,aqua.game.objects.forEach(function(a){(a.get(btb.Bullet)||a.get(btb.ShipMove)||a.get(btb.EnemyMove))&&aqua.game.destroy(a)}),aqua.game.player=btb.makeShip(),aqua.game.add(aqua.game.player)},cheat:function(){}},{},{makeLevelManager:function(){var a=e.create();return a}});btb.Level=d,btb.LevelManager=e})}(this,this.load),function(a,b){b.module("game/ship.js",when.all([b.script("game/bullet.js"),b.package("ship/ship.json")]),function(){var c=aqua.type(aqua.Component,{init:function(a){var b;this.inputMap=a.map,this.state={},this.deccelState=0;for(b in a.map)this.state[a.map[b]]={pressed:!1}},onadd:function(){a.addEventListener("keydown",this._keydown=this.keydown.bind(this)),a.addEventListener("keyup",this._keyup=this.keyup.bind(this))},ondestroy:function(){a.removeEventListener("keydown",this._keydown),a.removeEventListener("keyup",this._keyup)},get:function(a){return this.state[a].pressed},getPressTime:function(a){return this.state[a].pressed&&Date.now()-this.state[a].start},keydown:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!0,b.start||(b.start=Date.now())},keyup:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!1,delete b.start}}),d=aqua.type(aqua.Component,{init:function(a){this.inputMap=a.inputMap||a},ongameadd:function(b,c){this._keydown=this.keydown.bind(this),a.addEventListener("keydown",this._keydown),this.game=c},keydown:function(b){this.inputMap[b.keyCode]=="up"&&(a.removeEventListener("keydown",this._keydown),this.game.add(glider.makeShip()),this.game.destroy(this.gameObject))}}),e=aqua.type(aqua.Component,{firedelay:.5,ship:!0,init:function(a){this.def=a},onadd:function(a){this.input=a.get(c),this.moveModel=a.get(f),this.firetimer=0},update:function(){if(this.input.get("fire")){if(this.firetimer<=0&&this.moveModel.energy>=10){var a=this.def.bullet.speed||100,b=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0]+Math.cos(this.moveModel.angle)*this.moveModel.radius,this.moveModel.particle.position[1]+Math.sin(this.moveModel.angle)*this.moveModel.radius],velocity:[Math.cos(this.moveModel.angle)*a,Math.sin(this.moveModel.angle)*a],source:this.moveModel.particle}}));aqua.game.add(b),this.moveModel.energy-=10,$("#energy").css("width",this.moveModel.energy+"%"),this.firetimer=this.firedelay}}else this.input.get("fire2")?this.firetimer<=0&&this.moveModel.energy>=30&&([1,0,-1].forEach(function(a){var b=this.def.bullet.speed||100,c=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0]+Math.cos(this.moveModel.angle)*this.moveModel.radius,this.moveModel.particle.position[1]+Math.sin(this.moveModel.angle)*this.moveModel.radius],velocity:[Math.cos(this.moveModel.angle+Math.PI/8*a)*b,Math.sin(this.moveModel.angle+Math.PI/8*a)*b],source:this.moveModel.particle}}));aqua.game.add(c)}.bind(this)),this.moveModel.energy-=30,$("#energy").css("width",this.moveModel.energy+"%"),this.firetimer=this.firedelay):this.input.get("fire3")&&this.firetimer<=0&&this.moveModel.energy>=80&&([8,6,4,2,0,-2,-4,-6].forEach(function(a){var b=this.def.bullet.speed||100,c=btb.make(jQuery.extend(!0,{},this.def.bullet,{model:{position:[this.moveModel.particle.position[0]+Math.cos(this.moveModel.angle)*this.moveModel.radius,this.moveModel.particle.position[1]+Math.sin(this.moveModel.angle)*this.moveModel.radius],velocity:[Math.cos(this.moveModel.angle+Math.PI/8*a)*b,Math.sin(this.moveModel.angle+Math.PI/8*a)*b],source:this.moveModel.particle}}));aqua.game.add(c)}.bind(this)),this.moveModel.energy-=80,$("#energy").css("width",this.moveModel.energy+"%"),this.firetimer=this.firedelay);this.firetimer-=aqua.game.timing.delta}}),f=aqua.type(aqua.Component,{init:function(a){this.x=a.x||300,this.y=a.y||100,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.angle=0,this.radius=a.radius||25,this.score=0,this.angle=0,this.energy=0,this.particle=aqua.Particle.create([this.x,this.y,0],this.radius,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.particle.ship=this,this.particle.maxVelocity=(a.maxVelocity||50)*.05,this.playing=!1,this.decelState=0},onadd:function(a){this.input=a.get(c),$("#energy").css("width",this.energy+"%")},ondestroy:function(){this.input=null},ongameadd:function(a,b){b.world.addParticle(this.particle),this.game=b,this.world=b.world,this.sound=b.sound,this.x+=b.world.box.left},ongamedestroy:function(a,b){b.world.removeParticle(this.particle),b.score&&b.score.setMove(null),aqua.game.sound&&(aqua.game.sound.nodes.happy.source.gain.value=1,aqua.game.sound.nodes.zone.source.gain.value=0,aqua.game.sound.nodes.approach.source.gain.value=0),setTimeout("aqua.game.levelManager.playerdied()",3e3)},oncollision:function(a,b){a.enemy&&this.game.destroy(this.gameObject),a.bullet&&!a.bullet.energyHarvested&&a.bullet.isLive&&(a.bullet.energyHarvested=!0,this.energy<100&&(this.energy+=10),$("#energy").css("width",this.energy+"%"))},fixedUpdate:function(){this.input.get("left")&&(this.angle-=Math.PI*.04),this.input.get("right")&&(this.angle+=Math.PI*.04),this.input.get("up")&&(this.particle.acceleration[0]=Math.cos(this.angle)*100,this.particle.acceleration[1]=Math.sin(this.angle)*100);if(!this.input.get("down")||this.particle.velocity[0]===0&&this.particle.velocity[1]===0)this.decelState=0;else if(this.decelState==0){var a=(-this.particle.angle+3*Math.PI/2)%(Math.PI*2);this.angle=this.angle%(Math.PI*2),Math.abs(this.angle-a)<.01?(this.angle=a,this.decelState=1):this.angle>a?this.angle=this.angle-.2*(this.angle-a):this.angle<a&&(this.angle=this.angle+.2*(a-this.angle))}else this.decelState==1&&(Math.abs(this.particle.velocity[0])<.2&&(this.particle.velocity[0]=0,this.particle.x=this.particle.lastPosition[0],this.particle.position[0]=this.particle.x),Math.abs(this.particle.velocity[1])<.2&&(this.particle.velocity[1]=0,this.particle.y=this.particle.lastPosition[1],this.particle.position[1]=this.particle.y),Math.abs(this.particle.velocity[0])>=.2&&Math.abs(this.particle.velocity[0])>=.2&&(this.particle.acceleration[0]=Math.cos(this.angle)*100,this.particle.acceleration[1]=Math.sin(this.angle)*100))}}),g=aqua.type(aqua.Component,{onadd:function(a){this.ship=a.get(f),this.path||(this.pathAngle=0,this.path=new paper.Path([new paper.Point(90,-20),new paper.Point(20,0),new paper.Point(90,20)]),this.path.strokeColor="blue")},lateUpdate:function(){this.path.position.x=this.ship.particle.position[0],this.path.position.y=this.ship.particle.position[1],this.ship.angle!=this.pathAngle&&(this.path.rotate((this.ship.angle-this.pathAngle)/2/Math.PI*360),this.pathAngle=this.ship.angle)}}),h=aqua.type(aqua.RasterRenderer,{init:function(a){this.angle=0,Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this,a.image,f)},lateUpdate:function(){this.raster.position.x=this.transform.particle.position[0],this.raster.position.y=this.transform.particle.position[1],this.transform.angle!=this.angle&&(this.raster.rotate((this.transform.angle-this.angle)/2/Math.PI*360),this.angle=this.transform.angle)}});btb.makeShip=function(a){return btb.make(b.get("ship/ship.json"))},btb.ShipInput=c,btb.Ship=e,btb.ShipMove=f,btb.ShipRender=g,btb.ShipRasterRender=h})}(this,this.load)